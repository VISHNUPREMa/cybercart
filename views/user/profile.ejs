<%- include("../partials/header") %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    #error-messages {
    background-color: #f7d3d3;
    border: 1px solid #d35400;
    padding: 10px;
    margin-bottom: 10px;
    color: #d35400;
  }
  
</style>

    <main class="main">

       
        <section class="pt-150 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 m-auto">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false"><i class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false"><i class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                        </li>
                                      
                                        
                                        <li class="nav-item">
                                            <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#" onclick="showAddressTab()" aria-controls="address" aria-selected="true"><i class="fi-rs-marker mr-10"></i>My Address</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab" href="#" onclick="showAccountDetailTab()" aria-controls="account-detail" aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="coupon-tab" data-bs-toggle="tab" href="#" onclick="showCouponTab()" aria-controls="coupon" aria-selected="true"><i class="fi-rs-tag mr-10"></i>Coupon</a>
                                        </li>
                                        
                                        


                                        <li class="nav-item">
                                            <a class="nav-link" href="/logout"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="tab-content dashboard-content">
                                <% if(user){ %>
                                    <div class="tab-pane fade active show" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="mb-0">User Profile </h4>
                                            </div>
                                            <div class="card-body">
                                                <h5>Username : <%= user.name %></h5>
                                                <br>
                                                <h5>Email : <%= user.email %></h5>
                                                <br>
                                                <h5>Mobile : <%= user.mobile %></h5>
                                                <br>
                                                
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>

                                   
                                    <% if(coupons && coupons.length > 0) { %>
                                        <div class="tab-pane fade" id="coupon" role="tabpanel" aria-labelledby="coupon-tab">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">Coupons</h5>
                                                </div>
                                                <div class="card-body">
                                                    <% coupons.forEach(coupon => { %>
                                                        <h4>Coupon Code : <%= coupon.name %></h4>
                                                        <br>
                                                        <h5>Minimum Purchase Amount : <%= coupon.purchaseamount %></h5>
                                                        <br>
                                                        <h5>Discount : <%= coupon.discount %></h5>
                                                        <br>
                                                        <h5>Valid From : <%= coupon.start %></h5>
                                                        <br>
                                                        <h5>Valid To : <%= coupon.end %></h5>
                                                        <br>
                                                        <button style="background:none!important; border:none; padding:0!important; color:blue; text-decoration:underline; cursor:pointer;" onclick="copyToClipboard('<%= coupon.name %>')">if you want to copy coupon code click here</button>

                                                       
                                                        


                                                    <% }); %>
                                                </div>
                                            </div>
                                        </div>
                                    <% } else { %>
                                        <div class="tab-pane fade" id="coupon" role="tabpanel" aria-labelledby="coupon-tab">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">Coupons</h5>
                                                </div>
                                                <div class="card-body">
                                                    <p>No coupons available</p>
                                                </div>
                                            </div>
                                        </div>
                                    <% } %>
                                    


                                    <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Your Orders</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>Order ID</th>
                                                                <th>Date</th>
                                                                <th>Status</th>
                                                                <th>Total</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                      <% if(order){ %>
                                                        <% for(i=order.length-1;i>=0;i--){ %>
                                                        <tbody>
                                                            <tr>
                                                                <td><%= order[i].orderId %></td>
                                                                <td><%= order[i].createdon %></td>
                                                                <td><%= order[i].status %></td>
                                                                <td><%= order[i].totalprice %></td>
                                                                <td><a href="/orderdetails?id=<%= order[i]._id %>" class="btn-small d-block">View</a></td>
                                                            </tr>
                                                           
                                                           
                                                          
                                                        </tbody>
                                                        <% } %>

                                                        <% }else{ %>
                                                            <h3>no order</h3>
                                                            <% } %>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>




                                   

                                    
                                    <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                       
                                        <div class="row">
                                            <% if(address) { %>
                                                
                                            <% for(i=0;i<address.address.length;i++){ %>
                                                  
                                            <div class="col-lg-6">
                                                
                                                <div class="card mb-3 mb-lg-0">
                                                    <div class="card-header">
                                                        <h5 class="mb-0"><%= address.address[i].addresstype %></h5>
                                                        
                                                    </div>
                                                    <div class="card-body">
                                                        <address><%= address.address[i].name %><br> <%= address.address[i].housename %><br> <%= address.address[i].landmark %> <br><%= address.address[i].city %> <br><%= address.address[i].state %> <br> <%= address.address[i].pincode %> <br> <%= address.address[i].phone %> <br> <%= address.address[i].altphone %> </address>
                                                        <br><br>
                                                        <a href="/editaddress?id=<%= address.address[i]._id %> " class="btn-small"><h5>Edit</h5></a>
                                                    </div>
                                                </div>
                                                <br>
                                                
                                                
                                           
                                            </div>
                                            <% } %>
                                            <h5>create new address</h5>
                                            <form action="/createaddress" method="get">
                                                <button class="submit submit-auto-width" type="submit">Create New</button>
                                               </form>
                                           
                                          
                                            <% }else{ %>
                                                <div class="card-body">
                                                   <p>No Address Found <i class="fi-rs-marker mr-10"></i></p>
                                                   <form action="/createaddress" method="get">
                                                    <button class="submit submit-auto-width" type="submit">Create New</button>
                                                   </form>
                                                    <% } %>
                                        </div>
                                    </div>
                                   
                                            
                                        </div>


                                      



                                    <div class="tab-pane fade" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Account Details</h5>
                                            </div>
                                            <div class="card-body">
                                               
                                               
                                                    <% if(user){ %>
                                                    <div class="row">

                                                        <div id="error-messages" style="display: none;"></div>
                                                        <div class="form-group col-md-6">

                                                        

                                                            <label>Username <span class="required">*</span></label>
                                                            <input required  id="username" name="username" type="text" onkeyup="validateUsername()">
                                                            
                                                        </div>

                                                        <div class="form-group col-md-6">

                                                        

                                                            <label>Mobile <span class="required">*</span></label>
                                                            <input required  id="mobile" name="mobile" type="text" onkeyup="validateMobile()">
                                                            
                                                        </div>
                                                       
                                                        
                                                        <div class="form-group col-md-12">
                                                            <label>Email Address <span class="required">*</span></label>
                                                            <input required   id="email" name="email" type="email" onkeyup="validateUserEmail()">
                                                        </div>
                                                        <div class="form-group col-md-12">
                                                            <label>Current Password <span class="required">*</span></label>
                                                            <input  class="form-control square" id="currentpass" name="password" type="password">
                                                        </div>
                                                        <div class="form-group col-md-12">
                                                            <label>New Password <span class="required">*</span></label>
                                                            <input  class="form-control square" id="newpass" name="npassword"  type="password">
                                                        </div>
                                                        <div class="form-group col-md-12">
                                                            <label>Confirm Password <span class="required">*</span></label>
                                                            <input  class="form-control square" id="confirmpass" name="cpassword" type="password">
                                                        </div>
                                                       
                                                        <div class="col-md-12">
                                                            <button type="submit" id="btn" name="save" value="Submit" onclick="changePassword(event)">Save</button>

                                                        </div>
                                                    
                                                    </div>
                                                    <% } %>
                                              
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
       

       
        const actualUsername = "<%= user.name %>";
        const actualEmail = "<%= user.email %>"
        const errorMessageContainer = document.getElementById("error-messages");

        function validateUsername(){
            let alphabetPattern = /^[a-zA-Z\s]+$/;

            const usernameInput = document.querySelector('input[name="username"]');
        const username = usernameInput.value.trim();
        if(alphabetPattern.test(username)){
         
            errorMessageContainer.style.display = "none";
         
                return true
        }else{
          
            errorMessageContainer.style.display = "block";
                errorMessageContainer.textContent = "Invalid username"
         
            return false;
        }

          }


          function validateMobile(){
            const mobileInput = document.querySelector('input[name="mobile"]');
            const mobile = mobileInput.value.trim();
            const digits = /^\d{10}$/;
            if(digits.test(mobile)){
               
                errorMessageContainer.style.display = "none";
            
                return true

            }else{
                errorMessageContainer.style.display = "block";
                errorMessageContainer.textContent = "Invalid mobile number"
                
               
                return false
            }

    

          }

            function validateUserEmail(){
                const emailInput = document.getElementById("email");
                      const email = emailInput.value.trim();
                if(email === actualEmail){
                    errorMessageContainer.style.display = "none";
                  
               
                return true

                }else{
                    errorMessageContainer.style.display = "block";
                errorMessageContainer.textContent = "Invalid user emailid";
                  
                    return false;
                }
            }

            function changePassword(e){
                e.preventDefault();
                const usernameInput = document.querySelector('input[name="username"]');
        const username = usernameInput.value.trim();
        const mobileInput = document.querySelector('input[name="mobile"]');
            const mobile = mobileInput.value.trim();
                const currentpasswordInput = document.getElementById("currentpass");
                const currentpassword = currentpasswordInput.value.trim();
                const newpasswordInput =document.getElementById("newpass");
                const newpassword = newpasswordInput.value.trim();
                const confirmNewpasswordInput = document.getElementById("confirmpass");
                const confirmPassword = confirmNewpasswordInput.value.trim();
               
                if(validateUserEmail() && validateUsername() && validateMobile() ){
                   
          
                    $.ajax({
                        url:"/editprofile",
                        method:"POST",
                        data:{
                            name:username,
                            mobile:mobile,
                            currentpassword : currentpassword,
                            newpassword : newpassword,
                            confirmPassword : confirmPassword

                        },
                        success:function(res){
                            if(res.status == true){
                                
                                Swal.fire({
                              
                              icon: "success",
                              title: res.message,
                           showConfirmButton: false,
                         timer: 1500
                               });
                            }
                 
                        },
                        error:function(xhr){
                            if(xhr.status === 400){
                                
                       Swal.fire({
                         icon: "error",
                    title: "Oops...",
                     text: xhr.responseJSON.message,
                 
                    });

                            }
                            
                        }
                    })
                }
            }

        

            function showAddressTab() {
       
        document.getElementById("address").classList.add("active", "show");
        
    
        document.getElementById("dashboard").classList.remove("active", "show");
        document.getElementById("orders").classList.remove("active", "show");
        document.getElementById("account-detail").classList.remove("active", "show");
    }


    function showAccountDetailTab() {
     
        document.getElementById("account-detail").classList.add("active", "show");
        
    
        document.getElementById("dashboard").classList.remove("active", "show");
        document.getElementById("orders").classList.remove("active", "show");
        document.getElementById("address").classList.remove("active", "show");
    }


    function showCouponTab() {
        document.getElementById("coupon").classList.add("active", "show");
        document.getElementById("dashboard").classList.remove("active", "show");
        document.getElementById("orders").classList.remove("active", "show");
        document.getElementById("address").classList.remove("active", "show");
        document.getElementById("account-detail").classList.remove("active", "show");
    }

    function copyToClipboard(text) {
    var textarea = document.createElement("textarea");
    textarea.textContent = text;
    textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in MS Edge.
    document.body.appendChild(textarea);
    textarea.select();
    try {
        return document.execCommand("copy");  // Security exception may be thrown by some browsers.
    } catch (ex) {
        console.warn("Copy to clipboard failed.", ex);
        return false;
    } finally {
        document.body.removeChild(textarea);
    }
}


   


    </script>

   
    
    <%- include("../partials/footer") %>